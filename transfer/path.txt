 opt pag,nol ttl Print Pathname Utility lib sysdef opt lis pag info UniFLEX path info Version 1.01, Released March 26, 1984 info Copyright, (C) 1980, by info Technical Systems Consultants, Inc. info All rights reserved.* Print pathname utility org 0path ldd 0,s get arg count cmpd #1 lbne synerr ldu #nb+255 set up name buffer clr 0,u set null term lda #$d set cr pshu a we are bulding the backwards pathname here! sys status,dotf,stb get status of '.' ldd stb+2 get fdn number std curfdn save it cmpd #1 is it root? bne path2 lda #'/ set up slash pshu a save in name buffer bra path8path2 sys open,dottf,0 open parent for read std fd save file desc sys read,dbuf,32 read 1st two entries (. and ..)path4 ldd fd get file desc sys read,buf,16 get next dir entry lbes err error? cmpd #0 eof? lbeq err if so - error ldd buf get fdn number cmpd curfdn is it current fdn? bne path4 lbsr copnam copy name to pathname ldd fd get file desc sys close close the dir ldd dbuf get fdn number std curfdn save fdn cmpd #1 is it root? beq path8 sys chdir,dottf change to parent dir bra path2 repeat**************** Following added by DEV *********************path8 sys status,dotf,stb get status of assumed root ldy stb get device number into y sys status,slash,stb get status of real root cmpy stb compare to assumed root device beq path84 got full path if same sys open,slash,0 open root for read std fd save file desc sys read,dbuf,32 pass up 1st two entries (. and ..)path82 ldd fd get file desc sys read,buf,16 get next dir entry lbes err error? cmpd #0 eof? beq path83 can't find complete path clr buf+16 setup null name terminator lda #'/ sta buf+1 sys status,buf+1,stb get status of entry cmpy stb did we find mounted device? bne path82 if not, try next entry cmpu #nb+253 is name so far just "/"? bne path8f skip if more pulu a remove "/" from pathnamepath8f bsr copnam copy name to pathname bra path8cpath83 pulu a remove leading "/" ldd #1 standard output sys write,cdp,CZ "Can't determine complete pathname." ldd #1 standard output sys write,mtd,MZ "From root of mounted device:"path8c ldd fd sys close*************************************path84 stu iwrt2 save name pointer ldd #0 set counterpath85 tst 0,u+ count chars in name beq path9 incb bump count bra path85 repeatpath9 std iwrt3 save count for write ldd #1 set file desc sys ind,iwrt output name ldd #0 set status sys term exit* * routine to copy name from buffer to stacked path*copnam ldx #buf+16 point to end of namecopnm2 tst -1,x find last char of name bne copnm4 leax -1,x bra copnm2copnm4 lda 0,-x get name character pshu a push on name buffer cmpx #buf+2 last char? bne copnm4 lda #'/ set up / pshu a push on buffer rts** error routine*err ldd #2 set file desc sys write,er,E output error ldd #$ff set status sys term exit - errorsynerr ldd #2 set file desc sys write,sysms,SZ output error ldd #$ff set status sys term* data and stringser fcc "Can't determine pathname.",$dE equ *-ersysms fcc 'Command syntax error.',$dSZ equ *-sysmscdp fcc "Can't determine complete pathname.",$dCZ equ *-cdpmtd fcc 'From root of mounted device:  'MZ equ *-mtddottf fcc '.'dotf fcc '.',0slash fcc '/',0iwrt fcb writeiwrt2 fdb 0iwrt3 fdb 0curfdn fdb 0 current fdn numberfd fdb 0 file descbuf rmb 17 dir entry bufferdbuf rmb 32 . and .. bufferstb rmb 24 status buffernb rmb 256 name buffer end path